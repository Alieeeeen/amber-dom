{"version":3,"file":"amberdom.js","sources":["../src/util.js","../src/vnode/index.js","../src/h/index.js","../src/diff/patch-type.js","../src/diff/list-diff.js","../src/diff/index.js","../src/patch/index.js","../src/index.js"],"sourcesContent":["export function isArray (obj) {\n  return Object.prototype.toString.call(obj) === '[object Array]';\n}\n\nexport function isEmpty(obj) {\n  return Object.keys(obj|| {}).length === 0;\n}\n\nexport const eventHookRe = /^ev\\-([a-z]+)/;","import h from '../h/index';\nimport { isArray, eventHookRe } from '../util';\nexport default VNode;\n\n\nclass VNode {\n  /**\n   * @param {String} tagName a tag name. Must be specified.\n   * @param {Object} props can be an empty object.\n   * @param {Array} children can be an empty array.\n   */\n  constructor(tagName, props, children) {\n    this.tagName = tagName;\n    this.props = props;\n    this.children = children;\n    this.key = (props && props.key);\n    this.cleanups = []; // for cleaning up event listeners.\n    this.count = children && children.reduce((acc, child) => {\n      if (child instanceof VNode)\n        return child.count + acc + 1;\n      else\n        return acc + 1;\n    }, 0);\n    \n    if (this.key)\n      delete props.key; // no key will be needed anymore.\n  }\n\n  /**\n   * render a real DOM tree for this VTree rooted at this VNode.\n   */\n  render() {\n    const element = !(/(SVG|svg)/.test(this.tagName))\n      ? document.createElement(this.tagName)\n      : document.createElementNS(\n        \"http://www.w3.org/2000/svg\",\n        \"svg\"\n      );\n\n    const props = this.props;\n    const self = this;\n\n    for (const propName in props) {\n      if (props.hasOwnProperty(propName)) {\n        const _events = propName.match(eventHookRe);\n        if (_events) {\n          // FIXME: might be a better way of handling this.\n          try {\n            const handler = typeof props[propName] === 'function'\n              ? props[propName]\n              : new Function(`(${props[propName]})(...arguments);`);\n            \n            // store it for later detachment, to avoid memory\n            // leaking.\n            this.cleanups.push({\n              evName: _events[1],\n              handler: handler\n            });\n            // avoid bubbling.\n            element.addEventListener(_events[1], handler, false);\n          } catch(e) {\n            console.log(\n              `Warning: listener for event '${_event[1]}' isn't working.\n              If you're specifying this handler in string, please specify a function.`);\n          }\n        }\n        \n        else if (propName === 'className') {\n          element.setAttribute('class', props[propName])\n        }\n\n        else {\n          element.setAttribute(propName, props[propName]);\n        }\n      }\n    }\n\n    this.children.forEach(child => {\n      var childElement;\n\n      // It is a Text node.\n      if (typeof child === 'string') {\n        \n        childElement = document.createTextNode(child);  \n      }\n      // It is a VNode or custom node.\n      else if (child instanceof VNode ||\n        (child.render && typeof child.render === 'function')\n      ) {\n        childElement = child.render();\n      }\n\n      else {\n        throw new Error('Custom-defined node must provide a `render` method.');\n      }\n      element.appendChild(childElement);\n    });\n\n    this.$el = element;\n    return element;\n  }\n\n  detachEventListeners() {\n    this.cleanups.forEach(event => {\n      this.$el.removeEventListener(event.evName, event.handler);\n    });\n  }\n}","import VNode from '../vnode/index';\nimport { isArray, isEmpty } from '../util';\nexport default h;\n\n\nconst classIdSpliter = /([\\.#]?[^\\s#.]+)/;\nconst spaceStriper = /^\\s*|\\s*$/;\nconst propSpliter = /\\s*=\\s*/;\n\nfunction parseTagName(tagName) {\n  const parts = tagName.split(classIdSpliter);\n  const result = {};\n\n  parts.forEach(part => {\n    if (part === '')  return;\n\n    if (!result.tagName) {\n      result.tagName = part;\n    } else if (part[0] === '.') {\n      (result.className || (result.className = [])).push(part.substr(1));\n    } else if (part[0] === '#') {\n      result.id = part.substr(1);\n    }\n  });\n\n  result.className && result.className.join(' ');\n  return result;\n}\n\n/**\n * \n * @param {String|Function} tagName a built-in tag name or custom function that returns an object created by h.\n * @param {Object} props optional. any style, event listeners, and className should be put here.\n * @param {*} children optional children. Any string, instance of VNode will be children.\n */\nfunction h(tagName, props, ...children) {\n  var tagInfo, vnode;\n\n  if (typeof tagName === 'function') {\n    // use `new` in case it is a class.\n    return new tagName(props, ...children);\n  }\n\n  (props || (props = {}));\n  (children || (children = []));\n\n  // handle children re-maps.\n  if ((props instanceof VNode) ||\n      (typeof props === 'string')\n    ) {\n    children.unshift(props);\n    props = {};\n  }\n  \n  // handle children re-maps.\n  if (isArray(props)) {\n    children = [...props, children];\n    props = {};\n  }\n\n  // handle object-literal `style`.\n  if (props.style && typeof props.style === 'object') {\n    let style = '';\n\n    for (const key in props.style) {\n      style += `${key}: ${props.style[key]}; `;\n    }\n    props.style = style;\n  }\n\n  // handle array-literal `className`.\n  if (props.className && isArray(props.className)) {\n    props.className = props.className.join(' ');\n  }\n\n  if (typeof tagName === 'string') {\n    tagInfo = parseTagName(tagName);\n    if (tagInfo.className) {\n      (props.className || (props.className = ''));\n      props.className += ' ' + tagInfo.className;\n    }\n    if (tagInfo.id) {\n      props.id = props.id ? props.id : tagInfo.id;\n    }\n    // any children will be handled by VNode, remember there's no\n    // VText.\n    return new VNode(tagInfo.tagName, props, children);\n  } else {\n    throw new Error('The first parameter to `h` function must be a string or a function.')\n  }\n}","const REPLACE = 'REPLACE';\nconst REORDER = 'REORDER';\nconst PROPS = 'PROPS';\nconst TEXT = 'TEXT';\n\nconst patchType = {\n  REPLACE,\n  REORDER,\n  PROPS,\n  TEXT\n};\n\nexport default patchType;\n","import patchType from './patch-type';\nexport default diff;\n\n\nconst { REPLACE, REORDER, TEXT, PROPS } = patchType;\nfunction diff(oldList, newList, key) {\n  const oldListKeys = getKeys(oldList, key);\n  const newListKeys = getKeys(newList, key);\n  const oldListLength = oldList.length;\n  const newListLength = newList.length;\n  let diffed = oldList.slice();\n  let moves = [];\n\n  // Not a key was provied, don't diff.\n  if (noKeys(oldListKeys) && noKeys(newListKeys)) {\n    let op, start, end, index, inserted;\n\n    if (oldListLength === newListLength) {\n      return {\n        diffed,\n        moves\n      };\n    }\n\n    // Remove accessary nodes.\n    if (oldListLength > newListLength) {\n      op = 'REMOVE';\n      start = newListLength;\n      end = oldListLength;\n      diffed.splice(newListLength, oldListLength - newListLength);\n    }\n    \n    // Insert neccessary nodes.\n    else if (newListLength > oldListLength) {\n      op = 'INSERT';\n      start = oldListLength;\n      end = newListLength;\n      inserted = newList.slice(oldListLength);\n      diffed = [...diffed, ...inserted];\n    }\n\n    for (let i = start; i < end; i++) {\n      moves.push({\n        type: op,\n        index: i,\n        node: newList[i] || null  // It doesn't matter what.\n      });\n    }\n\n    return {\n      diffed,\n      moves\n    };\n\n  }\n  // record the move of the last element.\n  let indexDeltas = new Array(oldListLength).fill(0);\n  let _physicalIndex;\n\n  newListKeys.forEach((key, newIndex) => {\n    let _physicalIndex = oldListKeys.indexOf(key);\n\n    if (_physicalIndex === -1) {\n      // Element doesn't exist in `newList` yet. Tell it to\n      // insert it.\n      moves.push({\n        type: 'INSERT',\n        index: newIndex,\n        node: newList[newIndex]\n      });\n      diffed.splice(newIndex, 0, newList[newIndex]);\n\n      // positions of all unprocessed elements should take this delta.\n      indexDeltas[oldListLength - 1]++;\n    } else {\n      let oldIndex = _physicalIndex;\n\n      for (let i = oldListLength - 1; i >= _physicalIndex; i--) {\n        oldIndex += indexDeltas[i];\n      }\n\n      // If it is already in place, don't do anything.\n      if (newIndex === oldIndex)  return;\n\n      moves.push({\n        type: 'MOVE',\n        from: oldIndex, \n        to: newIndex\n      });\n      let _elem = diffed.splice(oldIndex, 1)[0];\n      diffed.splice(newIndex, 0, _elem);\n      newList[newIndex].$el = oldList[oldIndex].$el;\n\n      // It is impossible to move element from front to back.\n      indexDeltas[_physicalIndex]++;\n    }\n  });\n\n  // remove extra.\n  oldListKeys.forEach((key, i) => {\n    \n    if (newListKeys.indexOf(key) === -1) {\n      moves.push({\n        type: 'REMOVE',\n        index: newListLength,  // all extra items must've been moved to end.\n        node: diffed.splice(newListLength, 1)[0]\n      });\n    }\n  });\n\n  return {\n    diffed,\n    moves\n  };\n}\n\n// Elements with no `key` field is to be removed.\nfunction getKeys(list, key) {\n  return list.map((item, i) => {\n    if (key && item) {\n      return typeof key === 'function'\n        ? key(item)\n        : item[key];\n    } else  return void 0;\n  });\n}\n\n\nfunction noKeys(list) {\n  for (const item of list)\n    if (item !== void 0)\n      return false;\n\n  return true;\n}","import listDiff from './list-diff';\nimport { isEmpty } from '../util';\nimport patchType from './patch-type';\n\n\nconst { REPLACE, REORDER, TEXT, PROPS } = patchType;\n\nexport default function diff (oldTree, newTree) {\n  const patches = {};\n  walk(oldTree, newTree, patches, 0);\n  return patches;\n}\n\nfunction walk(oldNode, newNode, patches, index) {\n  var currPatches = [];\n  var propPatches, childrenPatches;\n\n  // TODO: let custom-defined component take control of diffing.\n\n  if (newNode === void 0) {\n    // oldNode will be removed.\n    return patches;\n  }\n\n  // both Text node.\n  else if (typeof oldNode === 'string' && typeof newNode === 'string') {\n\n    if (oldNode === newNode) {\n      // nothing to patch.\n    } else {\n      patches[index] = [{ type: TEXT, text: newNode }];\n    }\n    // there would be no props nor children.\n    return patches;\n  }\n\n  propPatches = diffProps(oldNode.props || {}, newNode.props || {});\n\n  // the whole node should be replaced, if tag names are not the same\n  // or keys diffed.splice(oldListLength, 0, ...inserted); are not the same.\n  if (oldNode.tagName !== newNode.tagName ||\n      oldNode.key !== newNode.key) {\n    \n      currPatches.push({\n        type: REPLACE,\n        node: newNode,\n        oldNode: oldNode  // for detaching event listeners.\n      });\n      patches[index] = currPatches;\n      // do not diff their children anymore.\n      return patches;\n  }\n  // only patch some props.\n  else if (!isEmpty(propPatches)) {\n    currPatches.push({\n      type: PROPS,\n      props: propPatches,\n      node: oldNode       // for detaching event listeners.\n    });\n    newNode.$el = oldNode.$el;\n  }\n\n  diffChildren(\n    oldNode.children || [],\n    newNode.children || [],\n    patches,\n    currPatches,\n    index\n  );\n  if (currPatches.length) {\n    patches[index] = currPatches;\n  }\n  return patches;\n}\n\nfunction diffProps(oldProps, newProps) {\n  var propPatches = {}, value;\n\n  // update props.\n  for (const propName in newProps) {\n    if (newProps.hasOwnProperty(propName)) {\n      value = newProps[propName];\n      if (oldProps[propName] !== value) {\n        propPatches[propName] = value;\n      }\n    }\n  }\n  // remove old props.\n  for (const propName in oldProps) {\n    if (!(propName in newProps))\n      propPatches[propName] = void 0;\n  }\n  return propPatches;\n}\n\n\nfunction diffChildren(oldChildren, \n  newChildren, patches, currPatches, index) {\n  const diffs = listDiff(oldChildren, newChildren, 'key');\n\n  oldChildren = diffs.diffed; // Must reorder them first before steppin deeper.\n  if (diffs.moves.length) {\n    currPatches.push({\n      type: REORDER,\n      moves: diffs.moves\n    });\n  }\n\n  var prevSibling = null;\n  var currIndex = index;\n  oldChildren.forEach((child, i) => {\n    const newChild = newChildren[i];\n    currIndex = (prevSibling && prevSibling.count)\n      ? prevSibling.count + currIndex + 1\n      : currIndex + 1;  // the first child.\n    walk(child, newChildren[i], patches, currIndex);\n    prevSibling = child;\n  });\n}","import VNode from '../vnode/index';\nimport patchType from '../diff/patch-type';\nimport { eventHookRe } from '../util';\nexport default patch;\n\n\nconst { REPLACE, REORDER, PROPS, TEXT } = patchType;\n\nfunction patch(domRoot, patches) {\n  walk(domRoot, patches, { index: 0 });\n}\n\n// walker keeps the complexity away.\n// `walk` updates the domTree buttom-up.\nfunction walk(domNode, patches, walker) {\n  const currPatches = patches[walker.index];\n  let   skipChildren = false;   // If it is a REPLACE patch, do not walk it.\n\n  // changes should be applied for this node first\n  if(currPatches) {\n    skipChildren = applyPatches(domNode, currPatches);\n  }\n\n  if (domNode.childNodes && !skipChildren) {\n    const childArr = [].slice.call(domNode.childNodes);\n    childArr.forEach((child, i) => {\n      walker.index++;\n      walk(child, patches, walker);\n    });\n  } else if (skipChildren) {\n    // don't forget to add them up.\n    walker.index += currPatches[0].oldNode.count;\n  }\n}\n\n\nfunction applyPatches(domNode, patches) {\n  let props, newNode, _events, skipChildren = false;\n\n  patches.forEach(patch => {\n    switch(patch.type) {\n    // FIXME: might be buggy.\n    case REPLACE:\n      newNode = (patch.node instanceof VNode || patch.node.render)\n        ? patch.node.render()\n        : typeof patch.node === 'string'\n        ? document.createTextNode(patch.node)\n        : new Error('You might be using a custom-defined node extended from VNode, if so, provide a render function.');\n      \n      if (newNode instanceof Error) {\n        throw newNode;\n      }\n\n      patch.oldNode.detachEventListeners();\n      domNode.parentNode.replaceChild(newNode, domNode);\n      skipChildren = true;\n      break;\n\n    case PROPS:\n      props = patch.props;\n      for (let propName in props) {\n        if ((_events = propName.match(eventHookRe))) {\n          // detach all event listeners added previously\n          patch.node.detachEventListeners();\n          if (typeof props[propName] === 'function')\n            domNode.addEventListener(_events[1], props[propName], false);\n        }\n\n        else if (props[propName] === void 0)\n          domNode.removeAttribute(propName !== 'className' ? propName : 'class');\n        else\n          domNode.setAttribute(propName !== 'className' ? propName : 'class', props[propName]);\n      }\n      break;\n\n    case TEXT:\n      if (domNode.textContent) {\n        domNode.textContent = patch.text;\n      } else {\n        domNode.nodeValue = patch.text;\n      }\n      break;\n    \n    case REORDER:\n      reorderChildren(domNode, patch.moves);\n      break;\n\n    default:\n      throw new Error('Some internal error.');\n    }\n  });\n\n  return skipChildren;\n}\n\n// TODO: Add batch.\nfunction reorderChildren(domNode, moves) {\n  const childNodes = domNode.childNodes;\n  let node;\n\n  moves.forEach(move => {\n  switch(move.type) {\n    case 'INSERT':\n      try {\n        node = move.node.render();\n        domNode.insertBefore(node, childNodes[move.index]);\n      } catch (e) {\n        console.log('You might be using a custom-defined node extended from VNode, if so, provide a render function.');\n      }\n      break;\n\n    case 'REMOVE':\n      domNode.removeChild(childNodes[move.index]);\n      move.node.detachEventListeners();\n      break;\n\n    case 'MOVE':\n      domNode.insertBefore(childNodes[move.from], childNodes[move.to]);\n      break;\n    }\n  });\n}","import h from './h/index';\nimport diff from './diff/index';\nimport patch from './patch/index';\nimport VNode from './vnode/index';\n\nconst amberdom = {\n  h,\n  diff,\n  patch,\n  VNode\n};\n\nexport default amberdom;"],"names":["isArray","obj","Object","prototype","toString","call","isEmpty","keys","length","eventHookRe","VNode","tagName","props","children","key","cleanups","count","reduce","acc","child","element","test","document","createElement","createElementNS","propName","hasOwnProperty","_events","match","handler","Function","push","evName","addEventListener","e","console","log","_event","setAttribute","forEach","childElement","createTextNode","render","Error","appendChild","$el","removeEventListener","event","classIdSpliter","parseTagName","parts","split","result","part","className","substr","id","join","h","tagInfo","unshift","style","REPLACE","REORDER","PROPS","TEXT","patchType","diff","oldList","newList","oldListKeys","getKeys","newListKeys","oldListLength","newListLength","diffed","slice","moves","noKeys","op","start","end","index","inserted","splice","i","type","node","indexDeltas","Array","fill","newIndex","_physicalIndex","indexOf","oldIndex","from","to","_elem","list","map","item","oldTree","newTree","patches","walk","oldNode","newNode","currPatches","propPatches","text","diffProps","diffChildren","oldProps","newProps","value","oldChildren","newChildren","diffs","listDiff","prevSibling","currIndex","newChild","patch","domRoot","domNode","walker","skipChildren","applyPatches","childNodes","childArr","detachEventListeners","parentNode","replaceChild","removeAttribute","textContent","nodeValue","reorderChildren","move","insertBefore","removeChild","amberdom"],"mappings":"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"}